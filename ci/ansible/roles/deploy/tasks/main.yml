---

- name: Ansible preparation
  block:
    - import_tasks: ansible_preparation.yml
  tags:
    - ansible

- name: Main tasks
  block:
    - name: Deploy tasks
      block:
        - import_tasks: common_setup.yml
        - import_tasks: deploy_files.yml
          tags:
            - deploy_files
        - import_tasks: get_mirror_repo.yml
          tags:
            - git
        - import_tasks: create_mirror_systemd_timer.yml
          tags:
            - update_list_timer
        - import_tasks: backend_installation.yml
          tags:
            - backend
        - import_tasks: nginx_configuration.yml
          tags:
            - nginx
        - import_tasks: local_valkey_setup.yml
          tags:
            - valkey
          when: local_dev is defined and local_dev
      tags:
        - deploy

    - name: Tests
      block:
        - import_tasks: tests.yml
      tags:
        - tests
  vars:
    ansible_python_interpreter: "/usr/bin/python3"
