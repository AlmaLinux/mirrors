---
- name: Prepare Python virtual environment
  pip:
    state: present
    name: "{{ python_packages }}"
    virtualenv: "{{ source_path }}/venv"
    virtualenv_command: "python3.12 -m venv"
  become: yes
  become_user: "{{ service_user }}"
  tags:
    - update_packages
    - virtualenv

- name: Prepare Gunicorn SELinux module
  block:
    - name: Check already installed module
      ansible.builtin.command:
        argv:
          - "semodule"
          - "--list-modules"
      register: se_modules

    - name: Compile SELinux module
      block:
        - name: Create gunicorn.mod
          ansible.builtin.command:
            argv:
              - "checkmodule"
              - "-M"
              - "-m"
              - "-o"
              - "{{ source_path }}/src/gunicorn.mod"
              - "{{ source_path }}/src/gunicorn.tt"

        - name: Create gunicorn.pp
          ansible.builtin.command:
            argv:
              - "semodule_package"
              - "-m"
              - "{{ source_path }}/src/gunicorn.mod"
              - "-o"
              - "{{ source_path }}/src/gunicorn.pp"

        - name: Install Gunicorn SELinux module
          ansible.builtin.command:
            argv:
              - "semodule"
              - "-i"
              - "{{ source_path }}/src/gunicorn.pp"
      when: "{{ 'gunicorn' not in se_modules.stdout }}"

    - name: Set SELinux security context of Gunicorn binary
      file:
        path: "{{ item }}"
        setype: bin_t
        seuser: system_u
        state: file
      with_items:
        - "{{ source_path }}/venv/bin/python3.12"
        - "{{ source_path }}/venv/bin/gunicorn"
      tags:
        - backend_selinux
  when: ansible_facts.selinux.status == 'enabled'

- name: Prepare started Py script
  template:
    dest: "{{ source_path }}/src/backend/{{ item }}"
    src: "{{ item }}.j2"
    owner: "{{ service_user }}"
    group: "{{ service_user }}"
    mode: 0600
  with_items:
    - "gunicorn.py"

- name: Prepare started script of backend service
  template:
    dest: "{{ scripts_path }}/{{ item }}.sh"
    src: "{{ item }}.sh.j2"
    owner: "{{ service_user }}"
    group: "{{ service_user }}"
    setype: bin_t
    seuser: system_u
    mode: 0740
  with_items:
    - "{{ mirror_service }}"

- name: Install systemd service of Gunicorn backend
  template:
    dest: "{{ systemd_services_path }}/{{ item }}.service"
    src: "{{ item }}.service.j2"
    group: "{{ service_user }}"
    owner: "{{ service_user }}"
    setype: systemd_unit_file_t
    seuser: system_u
    mode: 0640
  with_items:
    - "{{ mirror_service }}"

- name: Enable systemd service of Gunicorn backend
  systemd:
    name: "{{ item }}.service"
    state: restarted
    enabled: yes
    masked: no
    daemon_reload: yes
  tags:
    - backend_systemd_service
    - deploy_files
  with_items:
    - "{{ mirror_service }}"
