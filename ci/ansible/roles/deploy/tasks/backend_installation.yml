---
- name: Prepare Python virtual environment
  pip:
    state: present
    name: "{{ python_packages }}"
    virtualenv: "{{ source_path }}"
    virtualenv_command: "python3.9 -m venv"
  become: yes
  become_user: "{{ service_user }}"

- name: Prepare Gunicorn SELinux module
  block:
    - name: Check already installed module
      command:
        argv:
          - "semodule"
          - "--list-modules"
      register: se_modules

    - name: Compile SELinux module
      block:
        - name: Create gunicorn.mod
          command:
            argv:
              - "checkmodule"
              - "-M"
              - "-m"
              - "-o"
              - "{{ source_path }}/src/gunicorn.mod"
              - "{{ source_path }}/src/gunicorn.tt"

        - name: Create gunicorn.pp
          command:
            argv:
              - "semodule_package"
              - "-m"
              - "{{ source_path }}/src/gunicorn.mod"
              - "-o"
              - "{{ source_path }}/src/gunicorn.pp"

        - name: Install Gunicorn SELinux module
          command:
            argv:
              - "semodule"
              - "-i"
              - "{{ source_path }}/src/gunicorn.pp"
      when: "{{ 'gunicorn' not in se_modules.stdout }}"

    - name: Set SELinux security context of Gunicorn binary
      file:
        path: "{{ item }}"
        setype: bin_t
        seuser: system_u
      with_items:
        - "{{ source_path }}/bin/python3.9"
        - "{{ source_path }}/bin/gunicorn"

- name: Prepare gunicorn.py
  template:
    dest: "{{ source_path }}/src/backend/gunicorn.py"
    src: gunicorn.py.j2
    owner: "{{ service_user }}"
    group: "{{ service_user }}"
    mode: 0600
    force: yes

- name: Prepare started script of backend service
  template:
    dest: "/usr/local/bin/mirror_service_backend.sh"
    src: mirror_service_backend.sh.j2
    owner: "{{ service_user }}"
    group: "{{ service_user }}"
    mode: 0755
    force: yes

- name: Install systemd service of Gunicorn backend
  template:
    dest: "/etc/systemd/system/mirror_service_backend.service"
    src: mirror_service_backend.service.j2
    group: "{{ service_user }}"
    owner: "{{ service_user }}"
    mode: 0640
    force: 'yes'

- name: Enable systemd service of Gunicorn backend
  systemd:
    name: mirror_service_backend.service
    state: restarted
    enabled: yes
    masked: no
    daemon_reload: yes
  tags:
    - backend_systemd_service
